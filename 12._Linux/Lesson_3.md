# **Права доступа и пользователи**

### **Стандартная классификация пользователей в Linux**

Есть несколько видов пользователей для решения разных задач: обычные пользователи, системные пользователи и суперпользователь.

**Суперпользователь (root)** Администратор. Неограниченные права.  
● UID = 0 User ID  
● Home /root  
● Пароль не всегда. Не получится зайти через ssh. Не получится залогиниться в консоли.  
● Есть shell, bash  
● Неограниченные полномочия

**Системный пользователь (daemon)** Создаются для работы программ. Любой процесс в системе должен быть прикреплен к какому-то пользователю. Права максимально ограничены.  
● 1 < UID < 1000  
● Home Любая  
● Пароля нет  
● Нет shell В целях безопасности нет доступа к терминалу.  
● Ограниченный доступ

**Обычные пользователи (user)** нужны для полноценной работы в системе. Полноценный доступ в рамках своей домашней директории. Доступ к директориям других пользователей ограничен чтением или полностью.  
● UID > 1000  
● Home /home/user  
● Пароль установлен  
● Есть shell, bash  
● Доступ в рамках домашней директории  

---

### **Понятие UID, GID**

**UID** (*user ID*) - идентификатор пользователя. Операционная система различает пользователей именно по UID.
Есть возможность создать двух пользователей с разными логинами, но одинаковым UID, что позволит обоим
пользователям иметь одинаковые права доступа в системе. Это нарушение безопасности. UID у каждого пользователя должен быть уникальным, в ОС не должно быть двух пользователей с одинаковым UID.
UID - это число из диапазона от 0 до 65535, при этом UID 0 назначается суперпользователю. Во многих ОС диапазон от 1 до 999 используется под системные нужды, всё остальное — обычные пользователи.

**GID** (*group ID*) - идентификатор группы пользователей. Каждый пользователь в ОС Linux принадлежит как минимум к одной группе — группе по умолчанию, которая создаётся одновременно 
с учётной записью пользователя и как правило совпадает с именем пользователя. У пользователя может быть несколько групп. Пользователь может входить в группу с GID 0 (группа суперпользователя root), 
и это не будет нарушением безопасности. Группы необходимы для регулирования доступа нескольких пользователей к различным ресурсам.

Увидеть все основные свойства пользователей (включая UID и GID) и групп можно в обычных текстовых файлах, которые расположены в каталоге **/etc**.

---

### **Хранение данных пользователей (etc)**

● **/etc/passwd** – список пользователей. Для пользователя указана основная группа.

        1. логин пользователя;
        2. пароль (не используется);
        3. UID;
        4. GID (основная группа);
        5. полное имя пользователя и дополнительные поля;
        6. путь к оболочке.

        root:x:0:0:root:/root:/bin/bash
        sector:x:1000:1000:Evgeniy,,,:/home/sector:/bin/bash

● **/etc/group** – группы пользователей (дополнительные группы). Для пользователя указаны дополнительные группы.

        1. имя группы;
        2. пароль группы (не используется);
        3. GID (идентификатор группы);
        4. список членов группы (через запятую).

        root:x:0:
        sector:x:1000:
        adm:x:4:syslog,evgeniy

● **/etc/shadow** – пароли пользователей. Только с правами sudo или root.  
Очень опасно редактировать вручную. Делать это надо через терминал специальными командами. Эти файлы доступны для всех пользователей.  
Хранятся в обычных текстовых файлах. В пароле ! или * означает, что он не установлен.

        1. логин пользователя;
        2. пароль (в защищённом виде);
        3. дата последнего изменения пароля;
        4. минимальное число дней между изменениями паролей;
        5. максимальное время жизни пароля;
        6. количество дней до истечения срока действия пароля;
        7. количество дней после истечения срока действия пароля, когда учётная запись будет отключена;
        8. срок действия учетной записи.

        root:!:19256:0:99999:7::: логин : пароль : : 99999 - бесконечный пароль :

        evgeniy:$y$j9T$o9JzTi8r1l1XaBbuUzrYI.$EshPUXdDYIBDoWuYUGawZD.DGfPv02Cfhb.64ELyZW8:19256:0:99999:7::: 
        Пароль не хранится в открытом виде. Указан его хеш. Заблокировать пользователя можно просто поставив ! перед хеш.

---

### **Управление пользователями**

● useradd – создание пользователя (прописываем в ручную).  

        sudo useradd -s /bin/bash -m -d /home/testuser testuser

        sudo                 - выполнение от имени админа, не заходя в root.
        useradd              - создание пользователя.
        -s /bin/bash         - устанавливаем оболочку bash.
        -m                   - создать домашнюю директорию. Не создавать -M.
        -d /home/testuser    - точный путь к домашней директории.
        testuser             - логин пользователя.

        testuser:x:1001:1001::/home/testuser:/bin/bash   - что в итоге получилось (не добавили пароль). 

● adduser – создание пользователя (запускаем скрипт).

        sudo adduser testuser2

        Добавляется пользователь «testuser2» ...
        Добавляется новая группа «testuser2» (1002) ...
        Добавляется новый пользователь «testuser2» (1002) в группу «testuser2» ...
        Создаётся домашний каталог «/home/testuser2» ...
        Копирование файлов из «/etc/skel» ...
        Новый пароль: 14083
        Повторите ввод нового пароля: 14083
        passwd: пароль успешно обновлён
        Изменение информации о пользователе testuser2
        Введите новое значение или нажмите ENTER для выбора значения по умолчанию
        Полное имя []: kjhkjhkjh
        Номер комнаты []: 654543
        Рабочий телефон []: 987654432
        Домашний телефон []: 987765543
        Другое []: kjhiuytyuytuyt
        Данная информация корректна? [Y/n] y

        testuser2:x:1002:1002:kjhkjhkjh,654543,987654432,987765543,kjhiuytyuytuyt:/home/testuser2:/bin/bash 

● usermod – изменение пользователя.

        sudo usermod -aG adm testuser       - присваиваем пользователю дополнительную группу adm. Применяется когда пользователь перезайдет.    

        usermod    - изменение пользователя.
        -aG        - a(append)-добавить, (g - основная / G - дополнительная группа).
        adm        - название группы.
        testuser   - пользователь.

        sudo usermod -g www-data testuser   - Меняем основную группу.  
        sudo usermod -aG sudo testuser_3    - Делаем из простого пользователя суперпользователя (может использовать sudo).  
        sudo deluser testuser_3 sudo        - Отзываем возможность использовать sudo.  
        sudo id testuser                    - смотрим в каких группах находится testuser.  
        man usermod                         - смотрим справку по usermod. 

● userdel – удаление пользователя.

        sudo userdel testuser2.   - удаляем пользователя, домашний каталог остается.
        sudo userdel -r testuser  - удаление пользователя вместе с каталогом -r.

● passwd – изменение пароля.

        sudo passwd testuser  - меняем пароль для testuser. Запуск без sudo поменяет пароль текущего пользователя.

● chage – изменение свойств пароля (редко используется).

        sudo chage testuser

        Минимальный срок действия пароля [0]:
        Максимальный срок действия пароля [99999]:
        Последний раз пароль был изменён (ГГГГ-ММ-ДД) [2022-09-28]:
        Предупреждать об истечении срока действия пароля за [7]:
        Деактивировать учётную запись через [-1]:
        Дата истечения срока действия учётной записи (ГГГГ-ММ-ДД) [-1]:

        sudo chage -l testuser    - просмотр текущих настроек пароля.

● groupadd – создание группы

        sudo groupadd testgroup
        sudo groupdel testgroup

---

### **Механизм sudo и su**

● **su** (*switch user*) - переключение пользователя **su testuser**. **exit** - возвращение обратно.

● **sudo** - выполнение одной команды с правами админа (root).  
● **/etc/sudoers** – конфигурация sudo. Описаны все категории пользователей, которые могут выполнять эту команду.  
● **visudo** – редактирование sudoers. **sudo visudo** позволяет безопасно редактировать права доступа.  

● **sudo su** - переключение на суперпользователя (root) По умолчанию право использовать эту команду есть только у того, кто установил систему. У новых пользователей этого права по умолчанию нет.

Синтаксис записи в файле /etc/sudoers:

1. **User_name ALL= full_path_to_command**. Например, запись user ALL=/usr/sbin/adduser позволит пользователю с именем user, используя sudo, добавлять учётные записи в системе.
2. **User_name ALL=(ALL) ALL** позволит пользователю, используя утилиту sudo, выполнять административные действия без ограничений.
3. **%sudo ALL=(ALL) NOPASSWD:ALL** позволит всем пользователям, входящим в группу sudo, выполнять любые административные действия в системе без подтверждения паролем. В целях безопасности не рекомендуется использовать в многопользовательских решениях.

---

### **Механизм управления доступом к файлам**

У каждого файла или директории есть владелец (*owner*) и группа владельца (*group*). Эти два параметра определяют то, как будут действовать права доступа.  
Для изменения владельца нужно использовать утилиту **chown** (*change owner*).  
Если нужно изменить только группу владельца, то здесь полезна команда **chgrp**. Она имеет те же параметры, что и chown, только мы можем передавать исключительно группу.

>**ОПАСНЫЕ КОМАНДЫ**. Изменение права доступа к системным файлам может привести к невозможности загрузить систему. Указываем абсолютные пути.

        ● chown - изменение владельца и группы  
          ○ chown -R                 - (recursion) рекурсивно. Каталог + все вложенные элементы.  
          ○ chown testuser:testgroup - задаем владельца и группу.  
          ○ chown testuser           - задаем только владельца.  
        ● chgrp - изменение группы  
          ○ chgrp -R                 
          ○ chgrp testgroup  

        sudo chown testuser:www-data testt                   - задаем файлу testt владельца и группу.  
        sudo chown -R testuser:www-data /home/evgeniy/test3  - для каталога. Обязательно: -R.  
        sudo chgrp -R adm /home/sector/test3                 - задаем каталогу test3 группу adm.  

---

### **Права доступа к файлам rwx**

Ограничение прав доступа – важнейший аспект системы безопасности в Linux. Права доступа также называют битами доступа, потому что каждый символ в правах (например, r, w или x) 
означает флаг, который имеет 2 значения – включен или выключен.

Всего в стандартной системе прав доступа три группы по три бита в каждой (rwx). Первая группа относится к владельцу, вторая – к группе, третья – к остальным. Поиск совпадения производится слева направо. 
Если наш пользователь является владельцем файла, то он получает права владельца. Если он не владелец, но состоит в группе, которая назначена для файла, то он получит права для группы. 
И, наконец, если совпадения ни с владельцем, ни с группой не случилось, применяются права для остальных.

Биты прав доступа мы наблюдаем при вызове ls -l в первом столбце. Например: **-rw-rw-r–**  
Этот пример показывает обычный файл (**-**) с правами доступа **rw** (чтение и запись) для владельца и группы, и **r** (чтение) для остальных.

**В символьном виде**. Они расшифровываются следующим образом:  
● **r** (*read*) — возможность открытия и чтения файла или просмотр содержимого каталога.  
● **w** (*write*) — возможность изменить содержимое файла или возможность создавать, удалять или переименовывать объекты в каталоге.  
● **x** (*execute*) — возможность выполнить файл (запустить программу, скрипт) или возможность войти в каталог и получить атрибуты объектов.  

**В численном виде**, используя восьмеричную систему счисления:  
● **0** – нет битов;  
● **1** – x; ● **2** – w; ● **3** – wx;  
● **4** – r; ● **5** – rx; ● **6** – rw;  
● **7** – rwx.  

За изменение прав доступа отвечает команда **chmod** (*change mode*). Для назначения прав доступа мы можем использовать как текстовые обозначения, так и цифровые.

Начнём с примера в символьном виде: **chmod u=rwx,g+w,o-r testfile**  
В этом примере мы назначили права rwx для владельца – u, добавили право на запись для группы и убрали право на чтение для остальных. Таким образом, у нас есть несколько типов субъектов прав:  
● **u** (*user*) – владелец;  
● **g** (*group*) – группа;  
● **o** (*others*) – остальные;  
● **a** (*all*) – все.

Далее мы для каждого раздела (*ugoa*) назначаем действие:  
● **=** установить точные права;  
● **+** добавить биты доступа;  
● **-** убрать биты.  

Такая форма удобна, не требует запоминания восьмеричных цифр битов доступа.

Однако, если мы знаем точную формулу, гораздо быстрее назначить права в цифровом виде: **chmod -R 755 testdir/**  
Здесь мы назначили права (rwxr-xr-x) рекурсивно для всех вложенных элементов и самой директории. Получилось коротко и ёмко. Нужно помнить, что менять права доступа может либо владелец файла, либо суперпользователь root.

---

### **Специальные биты доступа SUID, SGID, sticky bit**

**SUID** (*set user ID upon execution*) — установка ID пользователя во время выполнения.  
Разрешает пользователям запускать файл на исполнение с правами того пользователя, которому принадлежит данный файл. В символьной записи присваивается следующим образом: **chmod u+s file**, где s — бит SUID. 
В численной записи имеет значение 4000, например **chmod 4755 file** присвоит права на чтение-запись-выполнение для владельца, права на чтение-выполнение — для группы владельца и всех остальных, 4 — выставит бит SUID. SUID работает с файлами.

**SGID** (*set group ID upon execution*) — установка ID группы во время выполнения, применяется преимущественно к каталогам.  
Данный атрибут устанавливает идентификатор группы каталога, а не группы владельца, который создал файл в этом каталоге. В символьной записи присваивается следующим образом: **chmod g+s dir1**, где s — бит SGID. 
В численной записи имеет значение 2000, например **chmod 2665 dir1** присвоит права на чтение-запись-просмотр для владельца и группы владельца и чтение-просмотр для всех остальных, а также установит на каталог бит SGID — 2.

**Sticky bit** — дополнительный атрибут, который устанавливается для каталогов.  
Файлы из каталога с таким битом может удалить только владелец (пользователь, создавший этот файл) или владелец каталога. В символьной записи присваивается следующим
образом: **chmod +t dir1** добавит к каталогу sticky bit. В численной записи имеет значение 1000, например **chmod 1666 dir1** установит на каталог права на
чтение-запись-просмотр для всех типов пользователей, но при этом удалять файлы могут только создатели благодаря установленному биту sticky.

---

### **Права по умолчанию и umask**

Когда мы создаём файл или директорию они получают права по умолчанию. Настройками этих прав заведует команда **umask**.  
Для определения прав по умолчанию нужно знать значение umask, которое применяется к нашему сеансу в данный момент. Узнать значение можно просто выполнив команду umask. Мы получим значение из четырёх восьмеричных цифр, например 0022. Эти цифры относятся к битам доступа, которые будут вычитаться из набора полных прав по умолчанию: 666 для файлов и 777 для директорий. Первая цифра относится к специальным битам и не используется, вторая – для владельца, третья – для группы, четвёртая – для остальных.

Определить права по умолчанию можно вычитая значение umask для каждого разряда из полных прав. Например, если umask имеет значение 022, то для файлов
права будут 644, а для директорий 755.
Изменить значение umask можно командой с набором битов. Например: umask 002.
Установить umask можно также в настройках оболочки пользователя (в файле ~/.bashrc) или глобально для всех пользователей (в /etc/bash.bashrc).

---
[Вернуться назад](<Linux.md>)